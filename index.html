<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gems Shop Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --accent: #ffb703; 
            --blue: #219ebc; --green: #2ecc71; --red: #e63946;
            --text: #fff; --subtext: #aaa;
            --chat-user: #007aff; --chat-support: #333;
        }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            margin: 0; padding: 20px; padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        /* UI ELEMENTS */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .wallet { font-weight: 800; font-size: 16px; display: flex; gap: 15px; }
        .wallet span span { color: var(--accent); }

        h2 { margin: 0 0 15px 0; font-size: 18px; }
        
        .game-card {
            background: var(--card); border-radius: 16px; height: 120px;
            position: relative; overflow: hidden; margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        .game-card:active { transform: scale(0.98); }
        .game-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }
        .game-title { position: absolute; bottom: 15px; left: 15px; font-weight: 800; font-size: 18px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

        /* PRODUCTS */
        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .item-card {
            background: var(--card); border-radius: 14px; padding: 10px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            position: relative; border: 1px solid transparent;
        }
        .item-card.offer { border-color: var(--red); }
        .offer-badge {
            position: absolute; top: -8px; right: -8px; background: var(--red);
            font-size: 10px; padding: 4px 8px; border-radius: 8px; font-weight: bold;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% {opacity:1;} 50% {opacity:0.7;} 100% {opacity:1;} }
        
        .item-img { width: 70px; height: 70px; border-radius: 10px; object-fit: cover; margin-bottom: 10px; background: #333; }
        
        .btn { width: 100%; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 12px; }
        .btn-buy { background: var(--blue); color: white; }
        .btn-get { background: var(--accent); color: black; animation: pop 0.3s; }
        @keyframes pop { 0%{transform:scale(0.8);} 100%{transform:scale(1);} }

        /* MODALS */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; display: none;
            flex-direction: column;
        }
        .modal-content {
            background: #1c1c1e; width: 100%; height: 100%;
            padding: 20px; box-sizing: border-box; overflow-y: auto;
        }

        /* CHAT */
        .chat-header { display: flex; align-items: center; gap: 10px; padding-bottom: 15px; border-bottom: 1px solid #333; }
        .support-tag { color: var(--green); font-size: 11px; background: rgba(46,204,113,0.1); padding: 2px 5px; border-radius: 4px; }
        
        .chat-box { flex: 1; overflow-y: auto; padding: 15px 0; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 18px; max-width: 80%; font-size: 14px; word-wrap: break-word; }
        .msg.user { align-self: flex-end; background: var(--chat-user); }
        .msg.support { align-self: flex-start; background: var(--chat-support); }
        .msg.system { align-self: center; background: transparent; color: #888; font-size: 12px; font-style: italic; }
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }
        
        .chat-input { display: flex; gap: 10px; margin-top: auto; align-items: center; }
        .chat-input input { flex: 1; padding: 12px; border-radius: 8px; border: none; background: #333; color: white; }
        
        /* –ö–ù–û–ü–ö–ê –ó–ê–ì–†–£–ó–ö–ò –§–û–¢–û */
        .attach-btn {
            background: none; border: none; color: #aaa; font-size: 24px; cursor: pointer; padding: 0 5px;
        }

        /* FLOATING BUTTONS & BADGE */
        .fab-chat {
            position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px;
            background: var(--green); border-radius: 50%; display: flex;
            justify-content: center; align-items: center; font-size: 28px;
            box-shadow: 0 5px 20px rgba(46,204,113,0.4); z-index: 100; cursor: pointer;
            transition: transform 0.2s;
        }
        .fab-chat:active { transform: scale(0.9); }
        
        /* –ë–ï–ô–î–ñ –ù–ï–ü–†–û–ß–ò–¢–ê–ù–ù–´–• */
        .chat-badge {
            position: absolute; top: -5px; right: -5px;
            background: var(--red); color: white; font-size: 12px; font-weight: bold;
            width: 20px; height: 20px; border-radius: 50%;
            display: none; justify-content: center; align-items: center;
            border: 2px solid var(--bg);
        }
        .chat-badge.show { display: flex; animation: bounce 0.3s; }
        @keyframes bounce { 0%{transform:scale(0);} 80%{transform:scale(1.2);} 100%{transform:scale(1);} }

        .fab-admin {
            position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px;
            background: var(--red); border-radius: 50%; display: none;
            justify-content: center; align-items: center; font-size: 24px;
            box-shadow: 0 5px 20px rgba(230,57,70,0.5); z-index: 100; cursor: pointer;
        }

        /* ADMIN TABS */
        .tab-nav { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { background: #333; color: #fff; padding: 8px 15px; border-radius: 8px; border: none; white-space: nowrap; }
        .tab-btn.active { background: white; color: black; }
        
        .form-input { width: 100%; padding: 12px; background: #2c2c2e; border: 1px solid #444; color: white; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .user-row { background: #2c2c2e; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }

        /* NOTIFICATION */
        .notif {
            position: fixed; top: 20px; left: 50%; transform: translate(-50%, -150%);
            background: rgba(30,30,30,0.95); backdrop-filter: blur(10px);
            padding: 10px 20px; border-radius: 30px; border: 1px solid #444;
            display: flex; align-items: center; gap: 10px; z-index: 3000;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 85%;
        }
        .notif.show { transform: translate(-50%, 0); }
    </style>
</head>
<body>

    <div id="screen-home">
        <div class="header">
            <div class="wallet">
                <span><span id="bal-c">0</span> üíé</span>
                <span><span id="bal-r">0</span> ‚ÇΩ</span>
            </div>
            <div id="username" style="color:var(--subtext)">...</div>
        </div>

        <h2>–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É</h2>
        <div id="games-container"></div>
    </div>

    <div id="screen-products" style="display:none;">
        <div class="header">
            <h2 id="game-title">–¢–æ–≤–∞—Ä—ã</h2>
            <button onclick="goHome()" style="background:none; border:none; color:var(--subtext); font-size:16px;">‚úï</button>
        </div>
        <div id="products-container" class="products-grid"></div>
    </div>

    <div id="modal-chat" class="modal">
        <div class="modal-content" style="display:flex; flex-direction:column;">
            <div class="chat-header">
                <div style="width:40px; height:40px; background:#ddd; border-radius:50%; overflow:hidden;">
                    <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" style="width:100%; height:100%; object-fit:cover;">
                </div>
                <div id="support-info" style="display:none;">
                    <div style="font-weight:bold;">–í–∏–∫–∞ –ö. <span class="support-tag">–ü–û–î–î–ï–†–ñ–ö–ê</span></div>
                    <div style="font-size:12px; color:var(--green)">Online</div>
                </div>
                <div id="support-loading" style="display:block;">
                    <div style="font-weight:bold;">–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</div>
                    <div style="font-size:12px; color:#aaa;">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
                </div>

                <button onclick="closeModal('modal-chat')" style="margin-left:auto; background:none; border:none; color:#aaa; font-size:20px;">‚úï</button>
            </div>
            
            <div id="chat-messages" class="chat-box"></div>
            
            <div class="chat-input">
                <button class="attach-btn" onclick="document.getElementById('file-in').click()">üìé</button>
                <input type="file" id="file-in" style="display:none" accept="image/*" onchange="handleFileSelect()">
                
                <input type="text" id="chat-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button onclick="sendMsg()" style="background:var(--chat-user); border:none; color:white; width:40px; border-radius:8px;">‚û§</button>
            </div>
        </div>
    </div>

    <div id="modal-email" class="modal" style="justify-content:center; align-items:center; background:rgba(0,0,0,0.8);">
        <div style="background:#252525; padding:25px; border-radius:20px; width:80%;">
            <h3 style="margin-top:0;">üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ</h3>
            <p style="color:#aaa; font-size:13px;">–í–≤–µ–¥–∏—Ç–µ ID / –ü–æ—á—Ç—É –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏:</p>
            <input type="text" id="email-in" class="form-input" placeholder="supercell_id...">
            <button onclick="submitEmail()" class="btn btn-buy" style="background:var(--green); font-size:14px; padding:12px;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <button onclick="closeModal('modal-email')" style="background:none; border:none; color:#aaa; width:100%; margin-top:10px;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="modal-admin" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>‚öôÔ∏è –ê–¥–º–∏–Ω–∫–∞</h2>
                <button onclick="closeModal('modal-admin')" style="background:none; border:none; color:#aaa;">‚úï</button>
            </div>

            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('adm-products')">–¢–æ–≤–∞—Ä—ã</button>
                <button class="tab-btn" onclick="switchTab('adm-crm')">CRM (–Æ–∑–µ—Ä—ã)</button>
            </div>

            <div id="adm-products">
                <select id="adm-p-game" class="form-input"></select>
                <input id="adm-p-name" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. 30 –ì–µ–º–æ–≤)">
                <input id="adm-p-pricec" type="number" class="form-input" placeholder="–¶–µ–Ω–∞ (–º–æ–Ω–µ—Ç—ã)">
                <input id="adm-p-pricer" type="number" class="form-input" placeholder="–¶–µ–Ω–∞ (—Ä—É–±–ª–∏)">
                <input id="adm-p-img" class="form-input" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É">
                <label style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                    <input type="checkbox" id="adm-p-offer"> –°–ø–µ—Ü–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–¢–∞–π–º–µ—Ä)
                </label>
                <button onclick="admAddProduct()" class="btn btn-buy">–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
            </div>

            <div id="adm-crm" style="display:none;">
                <button onclick="loadCrm()" style="width:100%; padding:10px; background:#444; border:none; color:white; border-radius:8px; margin-bottom:10px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <div id="crm-list"></div>
            </div>
        </div>
    </div>

    <div id="notif-toast" class="notif" onclick="openChat(currentChatUserId)">
        <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" style="width:35px; height:35px; border-radius:50%;">
        <div>
            <div style="font-weight:bold; font-size:13px;">–í–∏–∫–∞ –ö. <span style="color:var(--green)">[Support]</span></div>
            <div style="font-size:12px; color:#ccc;">–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
        </div>
    </div>

    <div class="fab-chat" onclick="openChat()">
        üí¨
        <div id="chat-badge" class="chat-badge">1</div>
    </div>
    <div id="fab-admin" class="fab-admin" onclick="openAdmin()">‚öôÔ∏è</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô NGROK
        const BASE_URL = "https://ardath-bootyless-homostyly.ngrok-free.dev";

        let USER_ID = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;
        let USERNAME = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : "–ì–æ—Å—Ç—å";

        if (!USER_ID) {
            let storedId = localStorage.getItem('guest_user_id');
            if (!storedId) {
                storedId = Math.floor(Math.random() * 1000000000); 
                localStorage.setItem('guest_user_id', storedId);
            }
            USER_ID = parseInt(storedId);
        }

        const ADMIN_ID_CONST = 947269219; // –¢–≤–æ–π ID
        
        let allGames = [];
        let allProducts = [];
        let purchasedItems = [];
        let currentChatUserId = USER_ID;
        let isAdmin = false;
        let chatInterval = null;
        let globalPollInterval = null; // –î–ª—è –ø–æ–ª–ª–∏–Ω–≥–∞ –±–µ–π–¥–∂–∞

        // --- API CORE ---
        async function api(endpoint, method='GET', body=null) {
            try {
                const opts = {
                    method, 
                    headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'}
                };
                if(body) opts.body = JSON.stringify(body);
                const res = await fetch(`${BASE_URL}${endpoint}`, opts);
                if(!res.ok) throw new Error("Server Error");
                const text = await res.text();
                try { return JSON.parse(text); } catch { console.error("HTML error:", text); return null; }
            } catch(e) { console.error(e); return null; }
        }

        // --- INITIALIZATION ---
        async function init() {
            const uData = await api('/api/user', 'POST', {user_id: USER_ID, username: USERNAME});
            if(uData) {
                document.getElementById('bal-c').innerText = uData.coins;
                document.getElementById('bal-r').innerText = uData.rubles;
                document.getElementById('username').innerText = USERNAME;
                
                if(uData.is_admin) {
                    isAdmin = true;
                    document.getElementById('fab-admin').style.display = 'flex';
                }
            }

            const data = await api('/api/data');
            if(data) {
                allGames = data.games;
                allProducts = data.products;
                renderGames();
            }

            // –ó–ê–ü–£–°–ö –ì–õ–û–ë–ê–õ–¨–ù–û–ô –ü–†–û–í–ï–†–ö–ò –°–û–û–ë–©–ï–ù–ò–ô (–î–õ–Ø –ë–ï–ô–î–ñ–ê)
            if(!globalPollInterval) globalPollInterval = setInterval(checkUnreadMessages, 3000);
        }

        function renderGames() {
            const cont = document.getElementById('games-container');
            cont.innerHTML = '';
            const admP = document.getElementById('adm-p-game');
            admP.innerHTML = '';
            allGames.forEach(g => {
                cont.innerHTML += `
                    <div class="game-card" onclick="openGame('${g.id}')">
                        <img src="${g.img}">
                        <div class="game-title">${g.name}</div>
                    </div>`;
                admP.innerHTML += `<option value="${g.id}">${g.name}</option>`;
            });
        }

        function openGame(gid) {
            const g = allGames.find(x => x.id === gid);
            document.getElementById('game-title').innerText = g.name;
            document.getElementById('screen-home').style.display = 'none';
            document.getElementById('screen-products').style.display = 'block';
            
            const cont = document.getElementById('products-container');
            cont.innerHTML = '';
            allProducts.filter(p => p.game_id === gid).forEach(p => {
                const isBought = purchasedItems.includes(p.id);
                const btnHtml = isBought 
                    ? `<button class="btn btn-get" onclick="openGetModal(${p.id})">–ü–û–õ–£–ß–ò–¢–¨</button>`
                    : `<button class="btn btn-buy" onclick="buyItem(${p.id}, ${p.price_c})">–ö—É–ø–∏—Ç—å</button>`;
                const offerHtml = p.is_offer ? `<div class="offer-badge">SALE</div>` : '';
                cont.innerHTML += `
                    <div class="item-card ${p.is_offer ? 'offer':''}">
                        ${offerHtml}
                        <img src="${p.img}" class="item-img" onerror="this.src='https://placehold.co/100'">
                        <div style="font-weight:bold; font-size:13px;">${p.name}</div>
                        <div style="font-size:11px; color:#aaa; margin-bottom:5px;">${p.price_c} üíé / ${p.price_r} ‚ÇΩ</div>
                        ${btnHtml}
                    </div>`;
            });
        }

        function goHome() {
            document.getElementById('screen-products').style.display = 'none';
            document.getElementById('screen-home').style.display = 'block';
        }

        async function buyItem(pid, price) {
            tg.showConfirm(`–°–ø–∏—Å–∞—Ç—å ${price} –º–æ–Ω–µ—Ç?`, async (ok) => {
                if(ok) {
                    const res = await api('/api/buy', 'POST', {user_id: USER_ID, price});
                    if(res && res.status === 'ok') {
                        document.getElementById('bal-c').innerText = res.new_balance;
                        purchasedItems.push(pid);
                        const gTitle = document.getElementById('game-title').innerText;
                        const g = allGames.find(x => x.name === gTitle);
                        if(g) openGame(g.id);
                    } else {
                        tg.showAlert(res ? res.message : "Error");
                    }
                }
            });
        }

        function openGetModal(pid) { document.getElementById('modal-email').style.display = 'flex'; }

        async function submitEmail() {
            const val = document.getElementById('email-in').value;
            if(!val) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");
            await api('/api/chat/send', 'POST', {user_id: USER_ID, sender: 'user', text: `[–ó–ê–ö–ê–ó] –î–∞–Ω–Ω—ã–µ: ${val}`});
            document.getElementById('modal-email').style.display = 'none';
            openChat(USER_ID); 
        }

        // --- CHAT SYSTEM ---
        function openChat(targetUid) {
            currentChatUserId = targetUid || USER_ID;
            document.getElementById('modal-chat').style.display = 'flex';
            
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ —á–∞—Ç - —Å–∫—Ä—ã–≤–∞–µ–º –±–µ–π–¥–∂ –∏ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
            document.getElementById('chat-badge').classList.remove('show');
            api('/api/chat/read', 'POST', {user_id: currentChatUserId});

            if (isAdmin) showSupportHeader(true); else checkSupportStatus();

            loadChat();
            if(!chatInterval) chatInterval = setInterval(loadChat, 2000);
        }

        function checkSupportStatus() { showSupportHeader(false); }
        function showSupportHeader(connected) {
            document.getElementById('support-info').style.display = connected ? 'block' : 'none';
            document.getElementById('support-loading').style.display = connected ? 'none' : 'block';
        }
        
        function closeModal(id) { 
            document.getElementById(id).style.display = 'none';
            if(id === 'modal-chat' && chatInterval) { clearInterval(chatInterval); chatInterval=null; }
        }

        // --- LOGIC: –ë–ï–ô–î–ñ –ù–ï–ü–†–û–ß–ò–¢–ê–ù–ù–´–• ---
        async function checkUnreadMessages() {
            // 1. –£–ë–†–ê–õ–ò –ü–†–û–í–ï–†–ö–£ if(isAdmin), –ß–¢–û–ë–´ –¢–´ –ú–û–ì –¢–ï–°–¢–ò–¢–¨ –ù–ê –°–ï–ë–ï
            
            // 2. –î–û–ë–ê–í–ò–õ–ò &t=${Date.now()} –ß–¢–û–ë–´ –°–ë–ò–¢–¨ –ö–≠–® –ò –ó–ê–°–¢–ê–í–ò–¢–¨ –¢–ï–õ–ï–ì–†–ê–ú –î–ï–õ–ê–¢–¨ –ù–û–í–´–ô –ó–ê–ü–†–û–°
            const msgs = await api(`/api/chat?user_id=${USER_ID}&t=${Date.now()}`);
            
            if(!msgs) return;

            // –°—á–∏—Ç–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –æ—Ç support
            let unreadCount = 0;
            msgs.forEach(m => {
                // –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å support –ò —Å—Ç–∞—Ç—É—Å "–Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ" (0)
                if(m.sender === 'support' && m.is_read === 0) {
                    unreadCount++;
                }
            });

            const badge = document.getElementById('chat-badge');
            if(unreadCount > 0) {
                badge.innerText = unreadCount;
                badge.classList.add('show');
                
                // (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –í–∏–±—Ä–∞—Ü–∏—è, –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (—Å–ª–æ–∂–Ω–µ–µ, –ø–æ–∫–∞ –ø—Ä–æ–ø—É—Å—Ç–∏–º)
            } else {
                badge.classList.remove('show');
            }
        }

        async function loadChat() {
            const msgs = await api(`/api/chat?user_id=${currentChatUserId}`);
            const box = document.getElementById('chat-messages');
            const wasEmpty = box.innerHTML === '';
            
            box.innerHTML = '';
            if(msgs && msgs.length > 0) {
                const hasSupportMsg = msgs.some(m => m.sender === 'support');
                if (hasSupportMsg) showSupportHeader(true);

                msgs.forEach(m => {
                    const div = document.createElement('div');
                    div.className = `msg ${m.sender}`;
                    
                    let content = `<div>${m.message}</div>`;
                    if(m.img) {
                        content += `<img src="${m.img}">`;
                    }
                    div.innerHTML = content;
                    box.appendChild(div);
                });
            }
            if (wasEmpty) box.scrollTop = box.scrollHeight;
        }

        // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò –§–û–¢–û ---
        
        function handleFileSelect() {
            const file = document.getElementById('file-in').files[0];
            if (!file) return;

            // –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –ø–æ—à–µ–ª
            const btn = document.querySelector('.attach-btn');
            const originalText = btn.innerText;
            btn.innerText = '‚è≥'; 

            // –°–∂–∏–º–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
            resizeAndSend(file, (base64) => {
                sendMsg(base64);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –æ–±—Ä–∞—Ç–Ω–æ
                btn.innerText = 'üìé';
                document.getElementById('file-in').value = ''; // –ß–∏—Å—Ç–∏–º –∏–Ω–ø—É—Ç
            });
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–∂–∞—Ç–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ (Magic!)
        function resizeAndSend(file, callback) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    // –°–æ–∑–¥–∞–µ–º —Ö–æ–ª—Å—Ç –¥–ª—è —Ä–∏—Å–æ–≤–∫–∏
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; // –°–∂–∏–º–∞–µ–º –¥–æ 800px —à–∏—Ä–∏–Ω—ã
                    const MAX_HEIGHT = 800;
                    
                    let width = img.width;
                    let height = img.height;

                    // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    
                    // –†–∏—Å—É–µ–º —É–º–µ–Ω—å—à–µ–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–æ–∫—É Base64 (–∫–∞—á–µ—Å—Ç–≤–æ 0.7 = 70%)
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    callback(dataUrl);
                }
            }
        }

        async function sendMsg(imgData = null) {
            const inp = document.getElementById('chat-in');
            const txt = inp.value.trim();
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ —Ç–µ–∫—Å—Ç–∞, –Ω–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ - –≤—ã—Ö–æ–¥
            if(!txt && !imgData) return;
            
            const sender = (isAdmin && currentChatUserId !== USER_ID) ? 'support' : 'user';
            
            await api('/api/chat/send', 'POST', {
                user_id: currentChatUserId, 
                sender, 
                text: txt || (imgData ? "üì∑ –§–æ—Ç–æ" : ""),
                img: imgData
            });
            
            inp.value = '';
            loadChat();

            // SCENARIO VIKA
            if (!isAdmin && sender === 'user') {
                const isOnline = document.getElementById('support-info').style.display === 'block';
                if (!isOnline) {
                    const box = document.getElementById('chat-messages');
                    const sysDiv = document.createElement('div');
                    sysDiv.className = 'msg system';
                    sysDiv.id = 'temp-searching';
                    sysDiv.innerText = 'üîç –ü–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏...';
                    box.appendChild(sysDiv);
                    box.scrollTop = box.scrollHeight;

                    setTimeout(async () => {
                        const el = document.getElementById('temp-searching');
                        if(el) el.remove();
                        showSupportHeader(true);
                        await api('/api/chat/send', 'POST', {
                            user_id: USER_ID, sender: 'support', 
                            text: 'üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ú–µ–Ω—è –∑–æ–≤—É—Ç –í–∏–∫–∞. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?'
                        });
                        loadChat();
                        tg.HapticFeedback.notificationOccurred('success');
                    }, 4000);
                }
            }
        }

        // --- ADMIN PANEL ---
        function openAdmin() { 
            document.getElementById('modal-admin').style.display = 'flex'; 
            switchTab('adm-products');
        }

        function switchTab(id) {
            ['adm-products','adm-crm'].forEach(t => document.getElementById(t).style.display='none');
            document.getElementById(id).style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if(id === 'adm-crm') loadCrm();
        }

        async function admAddProduct() {
            const body = {
                gameId: document.getElementById('adm-p-game').value,
                name: document.getElementById('adm-p-name').value,
                priceC: document.getElementById('adm-p-pricec').value,
                priceR: document.getElementById('adm-p-pricer').value,
                img: document.getElementById('adm-p-img').value,
                isOffer: document.getElementById('adm-p-offer').checked
            };
            const res = await api('/api/admin/add_product', 'POST', body);
            if(res) { tg.showAlert("–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω!"); }
        }

        async function loadCrm() {
            const users = await api('/api/admin/users');
            const cont = document.getElementById('crm-list');
            cont.innerHTML = '';
            if(users) users.forEach(u => {
                if (u.user_id === ADMIN_ID_CONST) return; 
                cont.innerHTML += `
                    <div class="user-row">
                        <div>
                            <div style="font-weight:bold;">${u.username}</div>
                            <div style="font-size:11px; color:#aaa;">ID: ${u.user_id} | üí∞ ${u.balance_coins}</div>
                        </div>
                        <button onclick="adminStartChat(${u.user_id})" style="background:#444; border:none; color:white; padding:5px 10px; border-radius:5px;">–ß–∞—Ç</button>
                    </div>`;
            });
            if(cont.innerHTML === '') cont.innerHTML = '<p style="color:#666; text-align:center">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>';
        }

        function adminStartChat(uid) {
            closeModal('modal-admin');
            openChat(uid);
        }

        init();
    </script>
</body>
</html>
