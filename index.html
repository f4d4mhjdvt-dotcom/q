<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gems Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0f0f0f; --card: #1c1c1e; --accent: #ffd700; --accent-glow: rgba(255, 215, 0, 0.3);
            --text: #ffffff; --text-sec: #8e8e93;
            --green: #30d158; --red: #ff453a; --blue: #0a84ff;
        }
        body {
            background-color: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0; padding: 0; padding-bottom: 90px;
            -webkit-tap-highlight-color: transparent; user-select: none;
        }
        
        /* --- LAYOUT & HEADER --- */
        .container { padding: 20px; padding-top: 70px; }
        .header {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(28, 28, 30, 0.85); backdrop-filter: blur(20px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; box-sizing: border-box; z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .balance-box { font-weight: 700; font-size: 16px; color: var(--text); }
        .balance-box span { color: var(--accent); }
        
        /* --- CARDS & GRIDS --- */
        h2 { font-size: 22px; margin-bottom: 20px; font-weight: 800; letter-spacing: -0.5px; }
        
        .game-card {
            height: 140px; border-radius: 20px; overflow: hidden; position: relative;
            margin-bottom: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(1); transition: transform 0.2s; border: 1px solid rgba(255,255,255,0.05);
        }
        .game-card:active { transform: scale(0.97); }
        .game-card img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.7); }
        .game-title {
            position: absolute; bottom: 15px; left: 20px; font-size: 20px; font-weight: 800;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }
        
        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .item-card {
            background: var(--card); border-radius: 16px; padding: 12px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            position: relative; border: 1px solid rgba(255,255,255,0.05);
        }
        .item-img { width: 80px; height: 80px; border-radius: 12px; object-fit: cover; margin-bottom: 10px; background: #2c2c2e; }
        .item-name { font-weight: 600; font-size: 13px; line-height: 1.2; margin-bottom: 5px; height: 32px; overflow: hidden; }
        .item-price { font-weight: 700; font-size: 14px; color: var(--accent); }
        .offer-tag {
            position: absolute; top: 8px; right: 8px; background: var(--red);
            font-size: 9px; padding: 3px 6px; border-radius: 6px; font-weight: 800;
        }

        .btn {
            width: 100%; padding: 10px; border: none; border-radius: 10px;
            font-weight: 600; font-size: 13px; cursor: pointer; margin-top: 8px;
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.7; }
        .btn-primary { background: var(--text); color: black; }
        .btn-accent { background: var(--accent); color: black; box-shadow: 0 4px 15px var(--accent-glow); }
        .btn-danger { background: var(--red); color: white; }

        /* --- BOTTOM BAR (NAV) --- */
        .bottom-nav {
            position: fixed; bottom: 20px; width: 100%; display: flex;
            justify-content: space-around; pointer-events: none; z-index: 1000;
        }
        .fab {
            width: 50px; height: 50px; border-radius: 50%; display: flex;
            justify-content: center; align-items: center; font-size: 24px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); pointer-events: auto;
            backdrop-filter: blur(10px); cursor: pointer; position: relative;
        }
        .fab-left { background: var(--card); border: 1px solid #333; color: #fff; } /* Admin */
        .fab-center { background: var(--accent); color: #000; width: 60px; height: 60px; margin-bottom: 10px; } /* Cart */
        .fab-right { background: var(--green); color: #fff; } /* Chat */
        
        .badge {
            position: absolute; top: -2px; right: -2px; background: var(--red); color: white;
            font-size: 10px; width: 18px; height: 18px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-weight: bold;
            border: 2px solid var(--bg);
        }

        /* --- MODALS --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; display: none;
            justify-content: flex-end; /* Bottom sheet logic */
        }
        .modal.center { justify-content: center; align-items: center; }
        
        .modal-content {
            background: #151515; width: 100%; max-height: 90vh;
            border-radius: 25px 25px 0 0; padding: 25px; box-sizing: border-box;
            overflow-y: auto; border-top: 1px solid #333; animation: slideUp 0.3s;
        }
        .modal.center .modal-content { width: 90%; border-radius: 20px; max-height: 80vh; animation: zoomIn 0.2s; }
        
        @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
        @keyframes zoomIn { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        /* --- CART UI --- */
        .cart-item {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card); padding: 10px; border-radius: 12px; margin-bottom: 10px;
        }
        .cart-price { font-weight: bold; }
        .old-price { text-decoration: line-through; color: #666; font-size: 12px; margin-right: 5px; }

        /* --- CHAT UI --- */
        .chat-box { height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .msg { padding: 10px 14px; border-radius: 16px; max-width: 80%; font-size: 14px; }
        .msg.user { align-self: flex-end; background: var(--blue); }
        .msg.support { align-self: flex-start; background: var(--card); }
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 5px; }

        /* --- ADMIN UI --- */
        .admin-tabs { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 15px; }
        .tab-btn { background: #333; color: #fff; padding: 8px 16px; border-radius: 20px; white-space: nowrap; font-size: 13px; }
        .tab-btn.active { background: var(--text); color: black; }
        input, select { width: 100%; padding: 12px; background: #222; border: 1px solid #333; color: white; border-radius: 10px; margin-bottom: 10px; box-sizing: border-box; }
        .icon-btn { background: none; border: none; font-size: 18px; padding: 5px; cursor: pointer; }

        /* --- EFFECTS --- */
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5000; }
        
        /* AUTH SCREEN */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212;
            z-index: 3000; display: none; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; text-align: center;
        }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div class="header">
        <div class="balance-box"><span>‚ÇΩ</span> <span id="balance">0</span></div>
        <div id="user-name" style="font-size: 14px; color: var(--text-sec);">...</div>
    </div>

    <div class="container" id="main-view">
        <div id="section-start">
            <h2>üî• –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏–≥—Ä—ã</h2>
            <div id="games-list"></div>
        </div>
        
        <div id="section-products" style="display:none;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <button onclick="goHome()" style="background:none; border:none; color:white; font-size:20px;">‚¨Ö</button>
                <h2 style="margin:0;" id="page-title">–¢–æ–≤–∞—Ä—ã</h2>
            </div>
            <div id="products-list" class="products-grid"></div>
        </div>
    </div>

    <div class="bottom-nav">
        <div id="btn-admin" class="fab fab-left" style="display:none;" onclick="openAdmin()">‚öôÔ∏è</div>
        
        <div class="fab fab-center" onclick="openCart()">
            üõí
            <div id="cart-badge" class="badge" style="display:none;">0</div>
        </div>
        
        <div class="fab fab-right" onclick="openChat()">
            üí¨
            <div id="chat-badge" class="badge" style="display:none;">1</div>
        </div>
    </div>

    <div id="modal-cart" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
                <span onclick="closeModal('modal-cart')" style="font-size:20px;">‚úï</span>
            </div>
            
            <div id="cart-items">
                <p style="text-align:center; color:#666; margin: 40px 0;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>
            </div>
            
            <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 15px;">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="promo-input" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥..." style="margin:0;">
                    <button onclick="applyPromo()" style="width:auto; padding:0 20px; background:#333; color:white; border-radius:10px;">OK</button>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:20px; font-weight:bold; font-size:18px;">
                    <span>–ò—Ç–æ–≥–æ:</span>
                    <span id="cart-total">0 ‚ÇΩ</span>
                </div>
                <button onclick="checkout()" class="btn btn-accent" style="padding: 15px; margin-top: 15px;">–û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó</button>
            </div>
        </div>
    </div>

    <div id="auth-screen">
        <h2 style="margin-bottom: 10px;">Supercell ID</h2>
        <p style="color:#aaa; font-size:13px; margin-bottom:30px;">–í–≤–µ–¥–∏—Ç–µ –ø–æ—á—Ç—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞</p>
        <input type="email" id="auth-email" placeholder="example@gmail.com" style="text-align:center;">
        <button onclick="submitAuth()" class="btn btn-primary" id="auth-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        <div id="auth-loader" style="display:none; margin-top:20px; color:var(--accent);">
            ‚ö° –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>
    </div>

    <div id="modal-chat" class="modal">
        <div class="modal-content">
            <div style="border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:10px; display:flex; justify-content:space-between;">
                <b>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</b>
                <span onclick="closeModal('modal-chat')">‚úï</span>
            </div>
            <div id="chat-box" class="chat-box"></div>
            <div style="display:flex; gap:10px; align-items:center;">
                <span onclick="uploadFile()" style="font-size:24px; color:#aaa;">üìé</span>
                <input type="file" id="chat-file" hidden onchange="handleFile(this)">
                <input type="text" id="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button onclick="sendMsg()" style="width:40px; background:var(--blue); color:white; border-radius:8px;">‚û§</button>
            </div>
        </div>
    </div>

    <div id="modal-admin" class="modal">
        <div class="modal-content" style="height:90vh;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <b>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</b> <span onclick="closeModal('modal-admin')">‚úï</span>
            </div>
            
            <div class="admin-tabs">
                <div class="tab-btn active" onclick="admTab('start')">–°—Ç–∞—Ä—Ç</div>
                <div class="tab-btn" onclick="admTab('products')">–¢–æ–≤–∞—Ä—ã</div>
                <div class="tab-btn" onclick="admTab('promos')">–ü—Ä–æ–º–æ</div>
                <div class="tab-btn" onclick="admTab('crm')">CRM</div>
            </div>

            <div id="adm-tab-start">
                <div id="adm-games-list"></div>
                <hr style="border-color:#333; margin:15px 0;">
                <h4>–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä—É</h4>
                <input id="new-g-id" placeholder="ID (–Ω–∞–ø—Ä. pubg)">
                <input id="new-g-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                <button onclick="uploadFileAdmin('new-g-img')" style="background:#333; width:100%; margin-bottom:10px; color:#aaa; padding:10px; border-radius:10px;">üìé –û–±–ª–æ–∂–∫–∞ –∏–≥—Ä—ã</button>
                <input type="hidden" id="new-g-img">
                <button onclick="admSaveGame()" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>

            <div id="adm-tab-products" style="display:none;">
                <h4>–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</h4>
                <select id="new-p-game"></select>
                <input id="new-p-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                <input id="new-p-price" type="number" placeholder="–¶–µ–Ω–∞ (RUB)">
                <button onclick="uploadFileAdmin('new-p-img')" style="background:#333; width:100%; margin-bottom:10px; color:#aaa; padding:10px; border-radius:10px;">üìé –ö–∞—Ä—Ç–∏–Ω–∫–∞ —Ç–æ–≤–∞—Ä–∞</button>
                <input type="hidden" id="new-p-img">
                <label><input type="checkbox" id="new-p-offer"> –°–ø–µ—Ü–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</label>
                <button onclick="admSaveProduct()" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                
                <h4 style="margin-top:20px;">–°–ø–∏—Å–æ–∫</h4>
                <div id="adm-products-list"></div>
            </div>

            <div id="adm-tab-promos" style="display:none;">
                <h4>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–¥–æ–≤</h4>
                <input id="promo-code" placeholder="–ö–æ–¥ (–Ω–∞–ø—Ä. FREE100)">
                <select id="promo-type">
                    <option value="item">–¢–æ–≤–∞—Ä (100% —Å–∫–∏–¥–∫–∞)</option>
                    <option value="spin">–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</option>
                </select>
                <select id="promo-val-item" style="display:block;"></select> <input id="promo-uses" type="number" placeholder="–ö–æ–ª-–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π" value="1">
                <button onclick="admCreatePromo()" class="btn btn-accent">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
            </div>

            <div id="adm-tab-crm" style="display:none;">
                <button onclick="loadCRM()" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <div id="crm-users-list" style="margin-top:15px;"></div>
            </div>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è NGROK URL
        const BASE_URL = "https://ardath-bootyless-homostyly.ngrok-free.dev";

        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let USER_ID = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;
        let USERNAME = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : "Guest";
        // Fake ID for browser testing
        if(!USER_ID) {
             let s = localStorage.getItem('gid'); 
             if(!s) { s=Math.floor(Math.random()*1e9); localStorage.setItem('gid',s); }
             USER_ID = parseInt(s);
        }

        let isAdmin = false;
        let dataStore = { games: [], products: [] };
        let cart = []; // [{id, name, price, img, promoApplied?}]
        let currentChatId = USER_ID;
        let appliedPromo = null; // {code, value (prodId)}
        let chatInterval = null; // --- –î–û–ë–ê–í–õ–ï–ù–û: –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞

        // --- API ---
        async function api(path, method='GET', body=null) {
            try {
                let opts = { method, headers: {'Content-Type':'application/json','ngrok-skip-browser-warning':'true'} };
                if(body) opts.body = JSON.stringify(body);
                let r = await fetch(BASE_URL+path, opts);
                if(!r.ok) throw new Error("API Error");
                return await r.json();
            } catch(e) { console.error(e); return null; }
        }

        // --- INIT ---
        async function init() {
            let u = await api('/api/user', 'POST', {user_id: USER_ID, username: USERNAME});
            if(u) {
                document.getElementById('balance').innerText = u.balance;
                document.getElementById('user-name').innerText = USERNAME;
                if(u.is_admin) {
                    isAdmin = true;
                    document.getElementById('btn-admin').style.display = 'flex';
                    // –ê–¥–º–∏–Ω: –∫–æ—Ä–∑–∏–Ω–∞ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ
                    document.querySelector('.fab-center').style.left = '50%';
                    document.querySelector('.fab-center').style.transform = 'translateX(-50%)';
                } else {
                    // –Æ–∑–µ—Ä: –∫–æ—Ä–∑–∏–Ω–∞ —Å–ª–µ–≤–∞
                    document.querySelector('.fab-center').classList.replace('fab-center', 'fab-left');
                }
            }
            
            let d = await api('/api/data');
            if(d) {
                dataStore = d;
                renderGames();
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–π–¥–∂–∏–∫–∞ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫
            setInterval(checkChat, 3000);
        }

        // --- RENDER ---
        function renderGames() {
            let h = '';
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç—ã –≤ –∞–¥–º–∏–Ω–∫–µ
            let sel = document.getElementById('new-p-game');
            let selP = document.getElementById('adm-p-game'); // –≤ —Å—Ç–∞—Ä–æ–º –∫–æ–¥–µ
            sel.innerHTML = ''; 
            
            dataStore.games.forEach(g => {
                h += `<div class="game-card" onclick="openProducts('${g.id}', '${g.name}')">
                        <img src="${g.img || 'https://placehold.co/400x150'}">
                        <div class="game-title">${g.name}</div>
                      </div>`;
                sel.innerHTML += `<option value="${g.id}">${g.name}</option>`;
            });
            document.getElementById('games-list').innerHTML = h;
            
            // Render promo items select
            let pSel = document.getElementById('promo-val-item');
            pSel.innerHTML = '';
            dataStore.products.forEach(p => {
                pSel.innerHTML += `<option value="${p.id}">${p.name} (${p.price}‚ÇΩ)</option>`;
            });
        }

        function openProducts(gid, gname) {
            document.getElementById('section-start').style.display = 'none';
            document.getElementById('section-products').style.display = 'block';
            document.getElementById('page-title').innerText = gname;
            
            let h = '';
            dataStore.products.filter(p => p.game_id === gid).forEach(p => {
                h += `<div class="item-card">
                        ${p.is_offer ? '<span class="offer-tag">SALE</span>' : ''}
                        <img src="${p.img || 'https://placehold.co/80'}" class="item-img">
                        <div class="item-name">${p.name}</div>
                        <div class="item-price">${p.price} ‚ÇΩ</div>
                        <button onclick="addToCart(${p.id})" class="btn btn-primary">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                      </div>`;
            });
            document.getElementById('products-list').innerHTML = h || '<p>–ü—É—Å—Ç–æ</p>';
        }

        function goHome() {
            document.getElementById('section-products').style.display = 'none';
            document.getElementById('section-start').style.display = 'block';
        }

        // --- CART LOGIC ---
        function addToCart(pid) {
            let p = dataStore.products.find(x => x.id === pid);
            cart.push({...p}); // Copy object
            updateCartUI();
            
            // Animation for button? Simple toast
            tg.HapticFeedback.notificationOccurred('success');
            // Animate badge
            let b = document.getElementById('cart-badge');
            b.classList.add('bounce');
            setTimeout(()=>b.classList.remove('bounce'), 300);
        }

        function updateCartUI() {
            let b = document.getElementById('cart-badge');
            b.innerText = cart.length;
            b.style.display = cart.length ? 'flex' : 'none';
            
            let list = document.getElementById('cart-items');
            if(!cart.length) {
                list.innerHTML = '<p style="text-align:center;color:#666;margin:40px 0;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
                document.getElementById('cart-total').innerText = '0 ‚ÇΩ';
                return;
            }
            
            let h = '';
            let total = 0;
            
            cart.forEach((item, idx) => {
                let priceDisplay = `${item.price} ‚ÇΩ`;
                let finalPrice = item.price;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥
                if (appliedPromo && appliedPromo.type === 'item' && String(appliedPromo.value) === String(item.id)) {
                    priceDisplay = `<span class="old-price">${item.price} ‚ÇΩ</span> <span style="color:var(--green)">0 ‚ÇΩ</span>`;
                    finalPrice = 0;
                }
                
                total += finalPrice;
                
                h += `<div class="cart-item">
                        <div>
                           <div style="font-weight:bold; font-size:13px;">${item.name}</div>
                           <div style="font-size:12px; color:#aaa;">${priceDisplay}</div>
                        </div>
                        <span onclick="removeFromCart(${idx})" style="color:var(--red); font-size:18px;">‚úï</span>
                      </div>`;
            });
            
            list.innerHTML = h;
            document.getElementById('cart-total').innerText = total + ' ‚ÇΩ';
        }

        function removeFromCart(idx) {
            cart.splice(idx, 1);
            // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ç–æ–≤–∞—Ä, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –±—ã–ª –ø—Ä–æ–º–æ–∫–æ–¥ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–º–æ? 
            // –ù–µ—Ç, –æ—Å—Ç–∞–≤–∏–º, –≤–¥—Ä—É–≥ –¥–æ–±–∞–≤—è—Ç —Å–Ω–æ–≤–∞. –ù–æ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã –º–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç.
            if(!cart.length) appliedPromo = null;
            updateCartUI();
        }

        async function applyPromo() {
            let code = document.getElementById('promo-input').value.trim();
            if(!code) return;
            
            let res = await api('/api/promo/check', 'POST', {code});
            if(res && res.valid) {
                if(res.type === 'item') {
                    // Check if item in cart
                    let hasItem = cart.some(x => String(x.id) === String(res.value));
                    if(hasItem) {
                        appliedPromo = { code, type: 'item', value: res.value };
                        tg.showAlert("–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω! –¢–æ–≤–∞—Ä —Ç–µ–ø–µ—Ä—å –±–µ—Å–ø–ª–∞—Ç–µ–Ω.");
                        updateCartUI();
                    } else {
                        tg.showAlert("–í –∫–æ—Ä–∑–∏–Ω–µ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞.");
                    }
                } else if(res.type === 'spin') {
                    // Logic for wheel (Not implemented fully in this view, just alert)
                    tg.showAlert("–û—Ç–∫—Ä—ã–≤–∞–µ–º –ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã! (–õ–æ–≥–∏–∫–∞ –∫–æ–ª–µ—Å–∞)");
                }
            } else {
                tg.showAlert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∏–ª–∏ –ª–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω");
            }
        }

        function openCart() { document.getElementById('modal-cart').style.display = 'flex'; updateCartUI(); }

        // --- CHECKOUT ---
        function checkout() {
            if(!cart.length) return;
            closeModal('modal-cart');
            
            // 1. Confetti
            fireConfetti();
            
            // 2. Open Auth after 1.5s
            setTimeout(() => {
                document.getElementById('auth-screen').style.display = 'flex';
            }, 1500);
        }

        async function submitAuth() {
            let email = document.getElementById('auth-email').value;
            if(!email) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –ø–æ—á—Ç—É");
            
            document.getElementById('auth-btn').style.display = 'none';
            document.getElementById('auth-loader').style.display = 'block';
            
            // Send Order to Server
            let total = parseInt(document.getElementById('cart-total').innerText);
            
            await api('/api/order', 'POST', {
                user_id: USER_ID,
                items: cart,
                total_price: total,
                promo_code: appliedPromo ? appliedPromo.code : null
            });
            
            // Wait 3s simulation
            setTimeout(async () => {
                document.getElementById('auth-screen').style.display = 'none';
                tg.showAlert("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω! –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏.");
                
                // Send chat msg
                await api('/api/chat/send', 'POST', {
                    user_id: USER_ID, sender: 'user', 
                    text: `[–ó–ê–ö–ê–ó] Email: ${email}. –¢–æ–≤–∞—Ä–æ–≤: ${cart.length}. –°—É–º–º–∞: ${total}`
                });
                
                cart = []; appliedPromo = null; updateCartUI();
                openChat();
            }, 3000);
        }

        // --- ADMIN FUNCTIONS ---
        function openAdmin() { document.getElementById('modal-admin').style.display = 'flex'; admTab('start'); }
        function admTab(t) {
            ['start','products','promos','crm'].forEach(x => document.getElementById('adm-tab-'+x).style.display='none');
            document.getElementById('adm-tab-'+t).style.display = 'block';
            // Render specific lists
            if(t === 'start') renderAdmGames();
            if(t === 'products') renderAdmProducts();
        }

        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö ADMIN GAMES ---

        // 1. –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –∏–≥—Ä (–î–æ–±–∞–≤–∏–ª–∏ data-name –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞)
        function renderAdmGames() {
            let h = '';
            dataStore.games.forEach(g => {
                h += `<div style="display:flex; gap:10px; margin-bottom:10px; align-items:center; background:#222; padding:10px; border-radius:10px;">
                        <img src="${g.img || ''}" style="width:50px; height:50px; object-fit:cover; border-radius:5px;">
                        
                        <div style="flex:1;">
                            <input value="${g.name}" id="name-${g.id}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="margin:0; margin-bottom:5px;">
                            <div style="font-size:10px; color:#666;">ID: ${g.id}</div>
                        </div>

                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <button onclick="admQuickSave('${g.id}')" style="background:#333; border:1px solid #444; color:white; border-radius:5px; padding:5px;">üíæ</button>
                            <button onclick="admUploadExisting('${g.id}')" style="background:#333; border:1px solid #444; color:white; border-radius:5px; padding:5px;">üì∑</button>
                        </div>
                      </div>`;
            });
            document.getElementById('adm-games-list').innerHTML = h;
        }

        // 2. –ë—ã—Å—Ç—Ä–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∏–≥—Ä—ã
        async function admQuickSave(gid) {
            let newName = document.getElementById('name-' + gid).value;
            // –ù–∞—Ö–æ–¥–∏–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É, —á—Ç–æ–±—ã –Ω–µ —Å—Ç–µ—Ä–µ—Ç—å –µ—ë
            let oldGame = dataStore.games.find(x => x.id === gid);
            
            await api('/api/admin/game', 'POST', {
                id: gid, 
                name: newName, 
                img: oldGame.img // –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
            });
            tg.showAlert("–ò–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ!");
            init(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        }

        // 3. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –¥–ª—è –°–£–©–ï–°–¢–í–£–Æ–©–ï–ô –∏–≥—Ä—ã (–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ä–∞–∑—É)
        function admUploadExisting(gid) {
            let inp = document.createElement('input'); 
            inp.type='file'; 
            inp.accept='image/*';
            inp.onchange = e => {
                resizeAndSend(e.target.files[0], async (b64) => {
                    let currentName = document.getElementById('name-' + gid).value;
                    
                    // –°—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    await api('/api/admin/game', 'POST', {
                        id: gid,
                        name: currentName,
                        img: b64
                    });
                    
                    tg.showAlert("–û–±–ª–æ–∂–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!");
                    init(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω
                });
            };
            inp.click();
        }
        
        // 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ù–û–í–û–ô –∏–≥—Ä—ã (–° –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ—à–∏–±–æ–∫)
        async function admSaveGame() {
            let id = document.getElementById('new-g-id').value.trim();
            let name = document.getElementById('new-g-name').value.trim();
            let img = document.getElementById('new-g-img').value;
            
            if(!id) return tg.showAlert("‚ùå –û—à–∏–±–∫–∞: –í–≤–µ–¥–∏—Ç–µ ID (–Ω–∞ –ª–∞—Ç–∏–Ω–∏—Ü–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä 'pubg')");
            if(!name) return tg.showAlert("‚ùå –û—à–∏–±–∫–∞: –í–≤–µ–¥–∏—Ç–µ –ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã");
            if(!img) return tg.showAlert("‚ùå –û—à–∏–±–∫–∞: –ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–ª–æ–∂–∫—É!");

            await api('/api/admin/game', 'POST', {id, name, img});
            
            tg.showAlert("‚úÖ –ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
            
            // –ß–∏—Å—Ç–∏–º –ø–æ–ª—è
            document.getElementById('new-g-id').value = '';
            document.getElementById('new-g-name').value = '';
            document.getElementById('new-g-img').value = '';
            
            init(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        }

        // Admin: Products
        function renderAdmProducts() {
            let h = '';
            dataStore.products.forEach(p => {
                h += `<div style="background:#222; padding:10px; margin-bottom:10px; border-radius:10px;">
                        <div style="display:flex; justify-content:space-between;">
                            <b>${p.name}</b> <span onclick="delProd(${p.id})" style="color:var(--red)">üóë</span>
                        </div>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <input value="${p.name}" placeholder="Name" style="width:50%">
                            <input value="${p.price}" type="number" placeholder="Price" style="width:30%">
                            <button onclick="tg.showAlert('–§—É–Ω–∫—Ü–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, —É–¥–∞–ª–∏—Ç–µ –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∑–∞–Ω–æ–≤–æ')">üíæ</button>
                        </div>
                      </div>`;
            });
            document.getElementById('adm-products-list').innerHTML = h;
        }
        
        // Admin: Create & Uploads
        async function uploadFileAdmin(targetId) {
            // Create dummy input
            let inp = document.createElement('input'); 
            inp.type='file'; 
            inp.accept='image/*';
            inp.onchange = e => {
                resizeAndSend(e.target.files[0], (b64) => {
                    document.getElementById(targetId).value = b64;
                    tg.showAlert("–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –≤ –ø–∞–º—è—Ç—å. –ù–∞–∂–º–∏—Ç–µ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å.");
                });
            };
            inp.click();
        }
        
        async function admSaveGame() {
            let id = document.getElementById('new-g-id').value;
            let name = document.getElementById('new-g-name').value;
            let img = document.getElementById('new-g-img').value;
            if(id && name) {
                await api('/api/admin/game', 'POST', {id, name, img});
                tg.showAlert("–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
                location.reload();
            }
        }
        
        async function admSaveProduct() {
             let body = {
                 action: 'add',
                 gameId: document.getElementById('new-p-game').value,
                 name: document.getElementById('new-p-name').value,
                 price: document.getElementById('new-p-price').value,
                 img: document.getElementById('new-p-img').value,
                 isOffer: document.getElementById('new-p-offer').checked
             };
             await api('/api/admin/product', 'POST', body);
             tg.showAlert("–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω");
             admTab('products'); // refresh
        }

        async function delProd(id) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                await api('/api/admin/product', 'POST', {action:'delete', id});
                admTab('products');
            }
        }
        
        async function admCreatePromo() {
            let body = {
                code: document.getElementById('promo-code').value,
                type: document.getElementById('promo-type').value,
                value: document.getElementById('promo-val-item').value,
                uses: document.getElementById('promo-uses').value
            };
            await api('/api/admin/promo', 'POST', body);
            tg.showAlert("–ö–æ–¥ —Å–æ–∑–¥–∞–Ω!");
        }
        
        // Admin: CRM
        async function loadCRM() {
            let u = await api('/api/admin/users');
            let h = '';
            u.forEach(user => {
                h += `<div class="cart-item">
                        <div>
                            <b>${user.username}</b> (ID: ${user.user_id})<br>
                            –ë–∞–ª–∞–Ω—Å: ${user.balance} ‚ÇΩ
                        </div>
                        <div style="display:flex; gap:5px;">
                             <button onclick="crmBal(${user.user_id}, 100)" style="background:#333; color:white;">+100</button>
                             <button onclick="openChat(${user.user_id})" style="background:var(--blue); color:white;">–ß–∞—Ç</button>
                        </div>
                      </div>`;
            });
            document.getElementById('crm-users-list').innerHTML = h;
        }
        
        async function crmBal(uid, amt) {
            await api('/api/admin/balance', 'POST', {action:'add', user_id:uid, amount:amt});
            loadCRM();
        }

        // --- UTILS (Chat, Image Resize, Confetti) ---
        // (Chat logic similar to previous, shortened for brevity)
        function openChat(uid) { 
            currentChatId = uid || USER_ID; 
            document.getElementById('modal-chat').style.display='flex'; 
            document.getElementById('chat-badge').style.display='none';
            api('/api/chat/read', 'POST', {user_id: USER_ID});
            
            // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ä–∞–∑—É
            loadChat();
            
            // 2. --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ ---
            if (chatInterval) clearInterval(chatInterval);
            chatInterval = setInterval(loadChat, 2000);
        }
        
        function closeModal(id) { 
            document.getElementById(id).style.display='none';
            // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞ ---
            if (id === 'modal-chat' && chatInterval) {
                clearInterval(chatInterval);
                chatInterval = null;
            }
        }
        
        async function checkChat() {
            // –î–æ–±–∞–≤–∏–ª–∏ &t=... –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞
            let msgs = await api(`/api/chat?user_id=${USER_ID}&t=${Date.now()}`);
            if(msgs) {
                let unread = msgs.filter(m => m.sender === 'support' && !m.is_read).length;
                let b = document.getElementById('chat-badge');
                b.innerText = unread;
                b.style.display = unread > 0 ? 'flex' : 'none';
            }
        }
        
        async function loadChat() {
            // –î–æ–±–∞–≤–∏–ª–∏ &t=... –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞
            let msgs = await api(`/api/chat?user_id=${currentChatId}&t=${Date.now()}`);
            let b = document.getElementById('chat-box');
            b.innerHTML = '';
            if(msgs) msgs.forEach(m => {
                b.innerHTML += `<div class="msg ${m.sender}">${m.message} ${m.img ? `<br><img src="${m.img}">` : ''}</div>`;
            });
        }
        
        async function sendMsg(img=null) {
            let t = document.getElementById('chat-input');
            if(!t.value && !img) return;
            let sender = (isAdmin && currentChatId !== USER_ID) ? 'support' : 'user';
            await api('/api/chat/send', 'POST', {user_id: currentChatId, sender, text: t.value, img});
            t.value = ''; loadChat();
        }
        
        function uploadFile() { document.getElementById('chat-file').click(); }
        function handleFile(input) { resizeAndSend(input.files[0], (b64)=>sendMsg(b64)); }
        
        function resizeAndSend(file, cb) {
            let r = new FileReader();
            r.readAsDataURL(file);
            r.onload = e => {
                let i = new Image(); i.src = e.target.result;
                i.onload = () => {
                    let c = document.createElement('canvas');
                    let w = i.width, h = i.height;
                    if(w>800) { h*=800/w; w=800; }
                    c.width=w; c.height=h;
                    c.getContext('2d').drawImage(i,0,0,w,h);
                    cb(c.toDataURL('image/jpeg', 0.7));
                }
            }
        }

        // Simple Confetti
        function fireConfetti() {
            let c = document.getElementById('confetti-canvas');
            let ctx = c.getContext('2d');
            c.width = window.innerWidth; c.height = window.innerHeight;
            let p = [];
            for(let i=0; i<100; i++) p.push({
                x: c.width/2, y: c.height, 
                vx: (Math.random()-0.5)*10, vy: -Math.random()*15-5, 
                c: `hsl(${Math.random()*360}, 100%, 50%)`
            });
            function draw() {
                ctx.clearRect(0,0,c.width,c.height);
                p.forEach((k,i) => {
                    k.x+=k.vx; k.y+=k.vy; k.vy+=0.5;
                    ctx.fillStyle=k.c; ctx.fillRect(k.x,k.y,5,5);
                    if(k.y>c.height) p.splice(i,1);
                });
                if(p.length) requestAnimationFrame(draw);
            }
            draw();
        }

        init();
    </script>
</body>
</html>
