<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gems Shop Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --accent: #ffb703;
            --blue: #219ebc;
            --green: #2ecc71;
            --red: #e63946;
            --text-main: #ffffff;
            --text-sec: #aaaaaa;
            --chat-bg-user: #007aff;
            --chat-bg-support: #333;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            margin: 0; padding: 0; padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        /* HEADER */
        .header {
            position: sticky; top: 0;
            background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 100; border-bottom: 1px solid #333;
        }
        .wallet { font-weight: 700; font-size: 14px; display: flex; gap: 15px; }
        
        /* GENERAL UI */
        .container { padding: 20px; }
        h2 { margin: 10px 0 20px 0; font-size: 18px; }
        
        /* GAME CARDS */
        .games-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .game-card {
            background: var(--card-bg); border-radius: 16px;
            height: 120px; position: relative; overflow: hidden;
            border: 2px solid transparent; cursor: pointer;
            transition: transform 0.1s;
        }
        .game-card:active { transform: scale(0.97); }
        .game-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        .game-title {
            position: absolute; bottom: 10px; left: 10px; right: 10px;
            font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            font-size: 14px;
        }

        /* PRODUCTS SLIDER & OFFER */
        .slider-container {
            display: flex; overflow-x: auto; gap: 15px; padding-bottom: 10px;
            scrollbar-width: none;
        }
        .slider-container::-webkit-scrollbar { display: none; }
        
        .item-card {
            min-width: 150px; background: var(--card-bg);
            border-radius: 14px; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            position: relative;
        }
        .item-card.special-offer { border: 1px solid var(--red); }
        .offer-badge {
            position: absolute; top: -8px; right: -8px;
            background: var(--red); color: white;
            font-size: 10px; padding: 4px 8px; border-radius: 10px;
            font-weight: bold; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        
        .item-img { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; margin-bottom: 10px; background: #333; }
        .timer { color: var(--red); font-size: 11px; font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; gap: 4px; }

        .btn {
            width: 100%; padding: 10px; border: none; border-radius: 8px;
            font-weight: 600; cursor: pointer; margin-top: auto; font-size: 13px;
        }
        .btn-buy { background: var(--blue); color: white; }
        .btn-get { background: var(--accent); color: black; animation: pop 0.3s; }
        @keyframes pop { 0% { transform: scale(0.8); } 100% { transform: scale(1); } }

        /* NOTIFICATIONS */
        .notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px);
            border: 1px solid #444; border-radius: 50px;
            padding: 10px 20px; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 2000;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer; width: 85%; max-width: 350px;
        }
        .notification.show { transform: translateX(-50%) translateY(0); }
        .notif-avatar { width: 35px; height: 35px; border-radius: 50%; background: #eee; object-fit: cover; }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            display: none; align-items: flex-end; /* Bottom sheet style */
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: #1c1c1e; width: 100%; border-radius: 20px 20px 0 0;
            padding: 25px; box-sizing: border-box; animation: slideUp 0.3s;
            max-height: 90vh; overflow-y: auto;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* CHAT UI */
        .chat-header {
            display: flex; align-items: center; gap: 10px; padding-bottom: 15px; border-bottom: 1px solid #333; margin-bottom: 15px;
        }
        .support-badge { background: rgba(46, 204, 113, 0.2); color: var(--green); padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 5px; }
        .chat-messages { height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-bottom: 15px; }
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; position: relative; }
        .msg.support { align-self: flex-start; background: var(--chat-bg-support); color: white; border-bottom-left-radius: 4px; }
        .msg.user { align-self: flex-end; background: var(--chat-bg-user); color: white; border-bottom-right-radius: 4px; }
        .chat-input-area { display: flex; gap: 10px; border-top: 1px solid #333; padding-top: 15px; }
        
        /* ADMIN UI */
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { background: #333; color: #fff; border:none; padding: 8px 12px; border-radius: 8px; font-size: 12px; white-space: nowrap; }
        .tab-btn.active { background: var(--text-main); color: black; }
        .admin-btn-float {
            position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px;
            background: #e63946; border-radius: 50%; color: white; font-size: 24px;
            display: none; justify-content: center; align-items: center; z-index: 90;
            box-shadow: 0 4px 15px rgba(230,57,70,0.6); cursor: pointer;
        }
        input, select { background: #2c2c2e; border: 1px solid #444; color: white; width: 100%; padding: 12px; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }

    </style>
</head>
<body>

    <div class="header">
        <div class="wallet">
            <span>üíé <span id="bal-coins">0</span></span>
            <span>‚ÇΩ <span id="bal-rub">0</span></span>
        </div>
        <div id="user-status" style="font-size:12px; color:#aaa;">–í —Å–µ—Ç–∏</div>
    </div>

    <div class="container">
        <h2 id="games-head">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É</h2>
        <div class="games-grid" id="games-container"></div>

        <div id="shop-section" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="selected-game-title">–¢–æ–≤–∞—Ä—ã</h2>
                <button onclick="backToGames()" style="background:none; border:none; color:#aaa;">‚úï –ù–∞–∑–∞–¥</button>
            </div>
            <div class="slider-container" id="products-container"></div>
        </div>
    </div>

    <div id="admin-float" class="admin-btn-float" onclick="openAdmin()">‚öôÔ∏è</div>

    <div id="notif-toast" class="notification" onclick="openChat()">
        <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" class="notif-avatar">
        <div>
            <div style="font-weight:bold; font-size:13px;">–í–∏–∫–∞ –ö. <span style="color:var(--green)">[Support]</span></div>
            <div style="font-size:12px; color:#ccc;">–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...</div>
        </div>
    </div>

    <div id="email-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h3>
            <p style="color:#aaa; font-size:13px; margin-bottom:20px;">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Supercell ID / Email –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏.</p>
            <input type="email" id="user-email" placeholder="name@example.com">
            <button onclick="submitEmail()" class="btn btn-buy">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <button onclick="closeModal('email-modal')" style="background:transparent; color:#aaa; width:100%; border:none; padding:10px;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="chat-modal" class="modal-overlay" style="z-index: 2500;">
        <div class="modal-content" style="height: 80vh;">
            <div class="chat-header">
                <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" style="width:40px; height:40px; border-radius:50%;">
                <div>
                    <div style="font-weight:bold;">–í–∏–∫–∞ –ö. <span class="support-badge">–ü–û–î–î–ï–†–ñ–ö–ê</span></div>
                    <div style="font-size:12px; color:var(--green);">Online</div>
                </div>
                <button onclick="closeModal('chat-modal')" style="margin-left:auto; background:none; border:none; color:#aaa; font-size:20px;">‚úï</button>
            </div>
            
            <div class="chat-messages" id="chat-box"></div>
            
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0;">
                <button onclick="sendUserMessage()" style="width:50px; background:var(--chat-bg-user); border:none; border-radius:8px; color:white;">‚û§</button>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal-overlay">
        <div class="modal-content" style="height: 85vh;">
            <h3>üõ† –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h3>
            
            <div class="admin-tabs">
                <button class="tab-btn active" onclick="switchTab('tab-products')">–¢–æ–≤–∞—Ä—ã</button>
                <button class="tab-btn" onclick="switchTab('tab-games')">–ò–≥—Ä—ã</button>
                <button class="tab-btn" onclick="switchTab('tab-users')">–Æ–∑–µ—Ä—ã / –ß–∞—Ç</button>
            </div>

            <div id="tab-products">
                <select id="adm-game-select"></select>
                <input type="text" id="adm-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (30 –ì–µ–º–æ–≤)">
                <input type="number" id="adm-price-c" placeholder="–¶–µ–Ω–∞ (–º–æ–Ω–µ—Ç—ã)">
                <input type="number" id="adm-price-r" placeholder="–¶–µ–Ω–∞ (—Ä—É–±–ª–∏)">
                <input type="text" id="adm-img" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É —Ç–æ–≤–∞—Ä–∞">
                
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                    <input type="checkbox" id="adm-offer" style="width:20px;">
                    <label>–°–ø–µ—Ü–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–¢–∞–π–º–µ—Ä)</label>
                </div>
                
                <button onclick="admAddProduct()" class="btn btn-buy" style="background:var(--green);">–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
            </div>

            <div id="tab-games" style="display:none;">
                <p style="font-size:12px; color:#aaa;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–ª–æ–∂–µ–∫ –∏–≥—Ä</p>
                <select id="adm-edit-game-id" onchange="loadGameData()">
                    <option value="brawl">Brawl Stars</option>
                    <option value="clash">Clash Royale</option>
                </select>
                <input type="text" id="adm-game-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞">
                <input type="text" id="adm-game-img" placeholder="URL –û–±–ª–æ–∂–∫–∏ (Banner)">
                <button onclick="admSaveGame()" class="btn btn-buy">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–ª–æ–∂–∫—É</button>
            </div>

            <div id="tab-users" style="display:none;">
                <p style="font-size:12px; color:#aaa;">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</p>
                <div style="background:#2c2c2e; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>@currentUser</strong>
                        <span style="color:var(--green)">Online</span>
                    </div>
                    <div style="font-size:12px; color:#aaa; margin-top:5px;">ID: 123456789</div>
                    <button onclick="admOpenChat()" style="width:100%; margin-top:10px; padding:8px; background:#444; border:none; color:white; border-radius:6px;">–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</button>
                </div>
            </div>

            <button onclick="closeModal('admin-modal')" style="margin-top:20px; background:transparent; color:#aaa; border:none; width:100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        const ADMIN_ID = 947269219; // <-- –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê –°–í–û–ô ID
        
        let user = JSON.parse(localStorage.getItem('shop_user')) || {
            coins: 50, rubles: 0, boughtItems: [], id: tg.initDataUnsafe.user?.id || 0
        };

        // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–≤ –ø–∞–º—è—Ç–∏)
        let games = JSON.parse(localStorage.getItem('shop_games')) || [
            { id: 'brawl', name: 'Brawl Stars', img: 'https://wallpapers.com/images/hd/brawl-stars-loading-screen-background-p7m8f2z9j0k1q3w4.jpg' },
            { id: 'clash', name: 'Clash Royale', img: 'https://images7.alphacoders.com/678/678122.jpg' }
        ];

        let products = JSON.parse(localStorage.getItem('shop_products')) || [
            { id: 1, gameId: 'brawl', name: '30 –ì–µ–º–æ–≤', priceC: 50, priceR: 99, img: 'https://cdn-icons-png.flaticon.com/512/2696/2696047.png', isOffer: false },
            { id: 2, gameId: 'brawl', name: 'Mega Box', priceC: 150, priceR: 299, img: 'https://cdn-icons-png.flaticon.com/512/3062/3062634.png', isOffer: true, expires: Date.now() + 3600000 }
        ];

        let chatHistory = JSON.parse(localStorage.getItem('shop_chat')) || [
            { sender: 'support', text: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã, —è –∑–¥–µ—Å—å.' }
        ];

        // 2. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        function init() {
            renderBalance();
            renderGames();
            
            const tgUser = tg.initDataUnsafe.user;
            if (tgUser && tgUser.id === ADMIN_ID) {
                document.getElementById('admin-float').style.display = 'flex';
            }
            
            // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–æ–≤
            setInterval(updateTimers, 1000);
        }

        // 3. –†–ï–ù–î–ï–†–ò–ù–ì
        function renderBalance() {
            document.getElementById('bal-coins').innerText = user.coins;
            document.getElementById('bal-rub').innerText = user.rubles;
        }

        function renderGames() {
            const container = document.getElementById('games-container');
            container.innerHTML = '';
            const admSelect = document.getElementById('adm-game-select');
            admSelect.innerHTML = '';

            games.forEach(g => {
                // –ö–∞—Ä—Ç–æ—á–∫–∞ –∏–≥—Ä—ã
                container.innerHTML += `
                    <div class="game-card" onclick="openGame('${g.id}')">
                        <img src="${g.img}">
                        <div class="game-title">${g.name}</div>
                    </div>
                `;
                // –û–ø—Ü–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ
                admSelect.innerHTML += `<option value="${g.id}">${g.name}</option>`;
            });
        }

        function openGame(gameId) {
            const game = games.find(g => g.id === gameId);
            document.getElementById('games-head').style.display = 'none';
            document.getElementById('games-container').style.display = 'none';
            document.getElementById('shop-section').style.display = 'block';
            document.getElementById('selected-game-title').innerText = game.name;
            
            renderProducts(gameId);
        }

        function backToGames() {
            document.getElementById('games-head').style.display = 'block';
            document.getElementById('games-container').style.display = 'grid';
            document.getElementById('shop-section').style.display = 'none';
        }

        function renderProducts(gameId) {
            const container = document.getElementById('products-container');
            container.innerHTML = '';
            
            const items = products.filter(p => p.gameId === gameId);
            
            items.forEach(p => {
                let btnHtml = '';
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫—É–ø–ª–µ–Ω –ª–∏ —Ç–æ–≤–∞—Ä (—Å—Ç–∞—Ç—É—Å "paid" –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ —Å–µ—Å—Å–∏–∏)
                const isPaid = user.boughtItems.includes(p.id);

                if (isPaid) {
                    btnHtml = `<button class="btn btn-get" onclick="openGetModal(${p.id})">–ü–û–õ–£–ß–ò–¢–¨</button>`;
                } else {
                    btnHtml = `<button class="btn btn-buy" onclick="buyItem(${p.id})">–ö—É–ø–∏—Ç—å</button>`;
                }

                let offerHtml = '';
                let timerHtml = '';
                if(p.isOffer) {
                    offerHtml = `<div class="offer-badge">SALE</div>`;
                    timerHtml = `<div class="timer" id="timer-${p.id}">‚è≥ 00:00:00</div>`;
                }

                container.innerHTML += `
                    <div class="item-card ${p.isOffer ? 'special-offer' : ''}">
                        ${offerHtml}
                        <img src="${p.img}" class="item-img" onerror="this.src='https://via.placeholder.com/100'">
                        <div style="font-weight:bold; font-size:14px; text-align:center;">${p.name}</div>
                        ${timerHtml}
                        <div style="font-size:12px; color:#aaa; margin:5px 0;">${p.priceC} ü™ô / ${p.priceR} ‚ÇΩ</div>
                        ${btnHtml}
                    </div>
                `;
            });
            updateTimers(); // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–∏—Ç—å —Ü–∏—Ñ—Ä—ã
        }

        // 4. –¢–ê–ô–ú–ï–†–´
        function updateTimers() {
            const now = Date.now();
            products.forEach(p => {
                if(p.isOffer && p.expires > now) {
                    const el = document.getElementById(`timer-${p.id}`);
                    if(el) {
                        const diff = p.expires - now;
                        const h = Math.floor(diff / (1000 * 60 * 60));
                        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const s = Math.floor((diff % (1000 * 60)) / 1000);
                        el.innerText = `‚è≥ ${h}:${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
                    }
                }
            });
        }

        // 5. –õ–û–ì–ò–ö–ê –ü–û–ö–£–ü–ö–ò –ò –ü–û–õ–£–ß–ï–ù–ò–Ø
        function buyItem(id) {
            const prod = products.find(p => p.id === id);
            // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ - –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
            if(user.coins >= prod.priceC) {
                tg.showConfirm(`–°–ø–∏—Å–∞—Ç—å ${prod.priceC} –º–æ–Ω–µ—Ç –∑–∞ ${prod.name}?`, (ok) => {
                    if(ok) {
                        user.coins -= prod.priceC;
                        user.boughtItems.push(id);
                        localStorage.setItem('shop_user', JSON.stringify(user));
                        renderBalance();
                        renderProducts(prod.gameId); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∞ "–ü–û–õ–£–ß–ò–¢–¨"
                    }
                });
            } else {
                tg.showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç! –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ–º–æ–∫–æ–¥—ã.');
            }
        }

        function openGetModal(prodId) {
            document.getElementById('email-modal').classList.add('active');
        }

        function submitEmail() {
            const email = document.getElementById('user-email').value;
            if(!email) return tg.showAlert('–í–≤–µ–¥–∏—Ç–µ Email');

            // –ê–Ω–∏–º–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const btn = document.querySelector('#email-modal .btn-buy');
            const originalText = btn.innerText;
            btn.innerText = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
            btn.disabled = true;

            setTimeout(() => {
                btn.innerText = originalText;
                btn.disabled = false;
                closeModal('email-modal');
                tg.showAlert('–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –û–∂–∏–¥–∞–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏.');
                
                // –≠–ú–£–õ–Ø–¶–ò–Ø: –ß–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –ø–∏—à–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∞
                setTimeout(() => {
                    showNotification("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∏–∂—É –≤–∞—à –∑–∞–∫–∞–∑. –ì–æ—Ç–æ–≤—ã –ø—Ä–∏–Ω—è—Ç—å —Ç–æ–≤–∞—Ä?");
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
                    chatHistory.push({ sender: 'support', text: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∏–∂—É –≤–∞—à –∑–∞–∫–∞–∑. –ì–æ—Ç–æ–≤—ã –ø—Ä–∏–Ω—è—Ç—å —Ç–æ–≤–∞—Ä?' });
                    localStorage.setItem('shop_chat', JSON.stringify(chatHistory));
                }, 4000);

            }, 2000);
        }

        // 6. –ß–ê–¢ –°–ò–°–¢–ï–ú–ê
        function showNotification(text) {
            const notif = document.getElementById('notif-toast');
            notif.querySelector('div div:last-child').innerText = text;
            notif.classList.add('show');
            tg.HapticFeedback.notificationOccurred('success');
            
            setTimeout(() => {
                notif.classList.remove('show');
            }, 5000);
        }

        function openChat() {
            document.getElementById('notif-toast').classList.remove('show');
            document.getElementById('chat-modal').classList.add('active');
            renderChat();
        }

        function renderChat() {
            const box = document.getElementById('chat-box');
            box.innerHTML = '';
            chatHistory.forEach(msg => {
                const div = document.createElement('div');
                div.className = `msg ${msg.sender}`;
                div.innerText = msg.text;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        }

        function sendUserMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;
            
            chatHistory.push({ sender: 'user', text: text });
            localStorage.setItem('shop_chat', JSON.stringify(chatHistory));
            input.value = '';
            renderChat();
        }

        // 7. –ê–î–ú–ò–ù –õ–û–ì–ò–ö–ê
        function openAdmin() { document.getElementById('admin-modal').classList.add('active'); }
        
        function switchTab(tabId) {
            document.querySelectorAll('.admin-tabs .tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            ['tab-products', 'tab-games', 'tab-users'].forEach(t => document.getElementById(t).style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
        }

        function admAddProduct() {
            const gameId = document.getElementById('adm-game-select').value;
            const name = document.getElementById('adm-name').value;
            const priceC = document.getElementById('adm-price-c').value;
            const priceR = document.getElementById('adm-price-r').value;
            const img = document.getElementById('adm-img').value;
            const isOffer = document.getElementById('adm-offer').checked;

            if(name) {
                products.push({
                    id: Date.now(),
                    gameId, name, priceC, priceR, img,
                    isOffer,
                    expires: isOffer ? Date.now() + 3600000 : 0 // +1 —á–∞—Å
                });
                localStorage.setItem('shop_products', JSON.stringify(products));
                tg.showAlert('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω');
                
                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª, –æ–±–Ω–æ–≤–∏–º
                const openGameTitle = document.getElementById('selected-game-title').innerText;
                if(openGameTitle !== '–¢–æ–≤–∞—Ä—ã') {
                   // –ú–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É, –µ—Å–ª–∏ –∑–Ω–∞–µ–º ID, –Ω–æ –ø—Ä–æ—â–µ —é–∑–µ—Ä—É –ø–µ—Ä–µ–∑–∞–π—Ç–∏
                }
            }
        }

        function loadGameData() {
            const id = document.getElementById('adm-edit-game-id').value;
            const game = games.find(g => g.id === id);
            if(game) {
                document.getElementById('adm-game-name').value = game.name;
                document.getElementById('adm-game-img').value = game.img;
            }
        }

        function admSaveGame() {
            const id = document.getElementById('adm-edit-game-id').value;
            const game = games.find(g => g.id === id);
            game.name = document.getElementById('adm-game-name').value;
            game.img = document.getElementById('adm-game-img').value;
            localStorage.setItem('shop_games', JSON.stringify(games));
            tg.showAlert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
            renderGames();
        }

        // –ê–¥–º–∏–Ω –ø–∏—à–µ—Ç –≤ —á–∞—Ç –æ—Ç –ª–∏—Ü–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
        function admOpenChat() {
            // –í —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –º—ã –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–æ—Ç –∂–µ —á–∞—Ç
            // –ù–æ –¥–æ–±–∞–≤–∏–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–∏—Å–∞—Ç—å –∫–∞–∫ support
            tg.showPopup({
                title: '–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è',
                message: '–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:',
                buttons: [{type: 'ok', id: 'send'}, {type: 'cancel'}]
            }, (btn) => {
                if(btn === 'send') {
                    // Telegram WebApp –Ω–µ –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ prompt. 
                    // –î–ª—è –¥–µ–º–æ –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–º –∑–∞–≥–æ—Ç–æ–≤–∫—É –∏–ª–∏ –Ω–∞–¥–æ –¥–µ–ª–∞—Ç—å input –≤ –∞–¥–º–∏–Ω–∫–µ.
                    // –î–∞–≤–∞–π —Å–¥–µ–ª–∞–µ–º —ç–º—É–ª—è—Ü–∏—é:
                    const text = "–Ø –Ω–∞ —Å–≤—è–∑–∏! –ö–∞–∫–æ–π —É –≤–∞—Å –≤–æ–ø—Ä–æ—Å?";
                    chatHistory.push({ sender: 'support', text: text });
                    localStorage.setItem('shop_chat', JSON.stringify(chatHistory));
                    tg.showAlert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
                }
            });
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        init();
    </script>
</body>
</html>
