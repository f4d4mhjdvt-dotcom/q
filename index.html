<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gems Shop Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --accent: #ffb703; 
            --blue: #219ebc; --green: #2ecc71; --red: #e63946;
            --text: #fff; --subtext: #aaa;
            --chat-user: #007aff; --chat-support: #333;
        }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            margin: 0; padding: 20px; padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        /* UI ELEMENTS */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .wallet { font-weight: 800; font-size: 16px; display: flex; gap: 15px; }
        .wallet span span { color: var(--accent); }

        h2 { margin: 0 0 15px 0; font-size: 18px; }
        
        .game-card {
            background: var(--card); border-radius: 16px; height: 120px;
            position: relative; overflow: hidden; margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        .game-card:active { transform: scale(0.98); }
        .game-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }
        .game-title {
            position: absolute; bottom: 15px; left: 15px;
            font-weight: 800; font-size: 18px; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        /* PRODUCTS */
        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .item-card {
            background: var(--card); border-radius: 14px; padding: 10px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            position: relative; border: 1px solid transparent;
        }
        .item-card.offer { border-color: var(--red); }
        .offer-badge {
            position: absolute; top: -8px; right: -8px; background: var(--red);
            font-size: 10px; padding: 4px 8px; border-radius: 8px; font-weight: bold;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% {opacity:1;} 50% {opacity:0.7;} 100% {opacity:1;} }
        
        .item-img { width: 70px; height: 70px; border-radius: 10px; object-fit: cover; margin-bottom: 10px; background: #333; }
        
        .btn {
            width: 100%; padding: 10px; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 12px;
        }
        .btn-buy { background: var(--blue); color: white; }
        .btn-get { background: var(--accent); color: black; animation: pop 0.3s; }
        @keyframes pop { 0%{transform:scale(0.8);} 100%{transform:scale(1);} }

        /* MODALS */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; display: none;
            flex-direction: column;
        }
        .modal-content {
            background: #1c1c1e; width: 100%; height: 100%;
            padding: 20px; box-sizing: border-box; overflow-y: auto;
        }

        /* CHAT */
        .chat-header {
            display: flex; align-items: center; gap: 10px; padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        .support-tag { color: var(--green); font-size: 11px; background: rgba(46,204,113,0.1); padding: 2px 5px; border-radius: 4px; }
        
        .chat-box { flex: 1; overflow-y: auto; padding: 15px 0; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 18px; max-width: 80%; font-size: 14px; }
        .msg.user { align-self: flex-end; background: var(--chat-user); }
        .msg.support { align-self: flex-start; background: var(--chat-support); }
        
        .chat-input { display: flex; gap: 10px; margin-top: auto; }
        .chat-input input {
            flex: 1; padding: 12px; border-radius: 8px; border: none; background: #333; color: white;
        }

        /* ADMIN */
        .admin-btn {
            position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px;
            background: var(--red); border-radius: 50%; display: none;
            justify-content: center; align-items: center; font-size: 24px;
            box-shadow: 0 5px 20px rgba(230,57,70,0.5); z-index: 100; cursor: pointer;
        }
        .tab-nav { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { background: #333; color: #fff; padding: 8px 15px; border-radius: 8px; border: none; white-space: nowrap; }
        .tab-btn.active { background: white; color: black; }
        
        .form-input { width: 100%; padding: 12px; background: #2c2c2e; border: 1px solid #444; color: white; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
        .user-row { background: #2c2c2e; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }

        /* NOTIFICATION */
        .notif {
            position: fixed; top: 20px; left: 50%; transform: translate(-50%, -150%);
            background: rgba(30,30,30,0.95); backdrop-filter: blur(10px);
            padding: 10px 20px; border-radius: 30px; border: 1px solid #444;
            display: flex; align-items: center; gap: 10px; z-index: 3000;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 85%;
        }
        .notif.show { transform: translate(-50%, 0); }
    </style>
</head>
<body>

    <div id="screen-home">
        <div class="header">
            <div class="wallet">
                <span><span id="bal-c">0</span> üíé</span>
                <span><span id="bal-r">0</span> ‚ÇΩ</span>
            </div>
            <div id="username" style="color:var(--subtext)">...</div>
        </div>

        <h2>–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É</h2>
        <div id="games-container"></div>
    </div>

    <div id="screen-products" style="display:none;">
        <div class="header">
            <h2 id="game-title">–¢–æ–≤–∞—Ä—ã</h2>
            <button onclick="goHome()" style="background:none; border:none; color:var(--subtext); font-size:16px;">‚úï</button>
        </div>
        <div id="products-container" class="products-grid"></div>
    </div>

    <div id="modal-chat" class="modal">
        <div class="modal-content" style="display:flex; flex-direction:column;">
            <div class="chat-header">
                <div style="width:40px; height:40px; background:#ddd; border-radius:50%; background-image:url('https://cdn-icons-png.flaticon.com/512/4140/4140048.png'); background-size:cover;"></div>
                <div>
                    <div style="font-weight:bold;">–í–∏–∫–∞ –ö. <span class="support-tag">–ü–û–î–î–ï–†–ñ–ö–ê</span></div>
                    <div style="font-size:12px; color:var(--green)">Online</div>
                </div>
                <button onclick="closeModal('modal-chat')" style="margin-left:auto; background:none; border:none; color:#aaa; font-size:20px;">‚úï</button>
            </div>
            <div id="chat-messages" class="chat-box"></div>
            <div class="chat-input">
                <input type="text" id="chat-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button onclick="sendMsg()" style="background:var(--chat-user); border:none; color:white; width:40px; border-radius:8px;">‚û§</button>
            </div>
        </div>
    </div>

    <div id="modal-email" class="modal" style="justify-content:center; align-items:center; background:rgba(0,0,0,0.8);">
        <div style="background:#252525; padding:25px; border-radius:20px; width:80%;">
            <h3 style="margin-top:0;">üì¶ –ü–æ–ª—É—á–µ–Ω–∏–µ</h3>
            <p style="color:#aaa; font-size:13px;">–í–≤–µ–¥–∏—Ç–µ ID / –ü–æ—á—Ç—É –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏:</p>
            <input type="text" id="email-in" class="form-input" placeholder="supercell_id...">
            <button onclick="submitEmail()" class="btn btn-buy" style="background:var(--green); font-size:14px; padding:12px;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <button onclick="closeModal('modal-email')" style="background:none; border:none; color:#aaa; width:100%; margin-top:10px;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="modal-admin" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>‚öôÔ∏è –ê–¥–º–∏–Ω–∫–∞</h2>
                <button onclick="closeModal('modal-admin')" style="background:none; border:none; color:#aaa;">‚úï</button>
            </div>

            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('adm-products')">–¢–æ–≤–∞—Ä—ã</button>
                <button class="tab-btn" onclick="switchTab('adm-games')">–ò–≥—Ä—ã</button>
                <button class="tab-btn" onclick="switchTab('adm-crm')">CRM (–Æ–∑–µ—Ä—ã)</button>
            </div>

            <div id="adm-products">
                <select id="adm-p-game" class="form-input"></select>
                <input id="adm-p-name" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. 30 –ì–µ–º–æ–≤)">
                <input id="adm-p-pricec" type="number" class="form-input" placeholder="–¶–µ–Ω–∞ (–º–æ–Ω–µ—Ç—ã)">
                <input id="adm-p-pricer" type="number" class="form-input" placeholder="–¶–µ–Ω–∞ (—Ä—É–±–ª–∏)">
                <input id="adm-p-img" class="form-input" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É">
                <label style="display:flex; gap:10px; align-items:center; margin-bottom:15px;">
                    <input type="checkbox" id="adm-p-offer"> –°–ø–µ—Ü–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (–¢–∞–π–º–µ—Ä)
                </label>
                <button onclick="admAddProduct()" class="btn btn-buy">–°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
            </div>

            <div id="adm-games" style="display:none;">
                <select id="adm-g-select" class="form-input" onchange="admLoadGame()"></select>
                <input id="adm-g-name" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã">
                <input id="adm-g-img" class="form-input" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±–ª–æ–∂–∫—É">
                <button onclick="admUpdateGame()" class="btn btn-buy">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–ª–æ–∂–∫—É</button>
            </div>

            <div id="adm-crm" style="display:none;">
                <div id="crm-list"></div>
            </div>
        </div>
    </div>

    <div id="notif-toast" class="notif" onclick="openChat(currentChatUserId)">
        <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" style="width:35px; height:35px; border-radius:50%;">
        <div>
            <div style="font-weight:bold; font-size:13px;">–í–∏–∫–∞ –ö. <span style="color:var(--green)">[Support]</span></div>
            <div style="font-size:12px; color:#ccc;">–í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É!</div>
        </div>
    </div>

    <div id="fab-admin" class="admin-btn" onclick="openAdmin()">‚öôÔ∏è</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô NGROK (–ë–ï–ó –°–õ–ï–®–ê –í –ö–û–ù–¶–ï)
        const BASE_URL = "https://ardath-bootyless-homostyly.ngrok-free.dev";

        let USER_ID = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 947269219; // –¢–ï–°–¢ ID
        const USERNAME = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : "User";
        
        let allGames = [];
        let allProducts = [];
        let purchasedItems = []; // –•—Ä–∞–Ω–∏–º ID –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Å–µ—Å—Å–∏–∏
        let currentChatUserId = USER_ID; // –° –∫–µ–º —Å–µ–π—á–∞—Å —á–∞—Ç (–¥–ª—è –∞–¥–º–∏–Ω–∞ –≤–∞–∂–Ω–æ)
        let isAdmin = false;
        let chatInterval = null;

        // --- API CORE ---
        async function api(endpoint, method='GET', body=null) {
            try {
                const opts = {
                    method, 
                    headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'}
                };
                if(body) opts.body = JSON.stringify(body);
                const res = await fetch(`${BASE_URL}${endpoint}`, opts);
                if(!res.ok) throw new Error("Server Error");
                const text = await res.text();
                try { return JSON.parse(text); } catch { console.error("HTML error:", text); return null; }
            } catch(e) { console.error(e); tg.showAlert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏!"); return null; }
        }

        // --- INITIALIZATION ---
        async function init() {
            // 1. Get User Data
            const uData = await api('/api/user', 'POST', {user_id: USER_ID, username: USERNAME});
            if(uData) {
                document.getElementById('bal-c').innerText = uData.coins;
                document.getElementById('bal-r').innerText = uData.rubles;
                document.getElementById('username').innerText = USERNAME;
                
                if(uData.is_admin) {
                    isAdmin = true;
                    document.getElementById('fab-admin').style.display = 'flex';
                }
            }

            // 2. Load Content
            const data = await api('/api/data');
            if(data) {
                allGames = data.games;
                allProducts = data.products;
                renderGames();
            }
        }

        // --- GAMES & PRODUCTS UI ---
        function renderGames() {
            const cont = document.getElementById('games-container');
            cont.innerHTML = '';
            // –ê–¥–º–∏–Ω–∫–∞: —Å–µ–ª–µ–∫—Ç—ã
            const admG = document.getElementById('adm-g-select');
            const admP = document.getElementById('adm-p-game');
            admG.innerHTML = ''; admP.innerHTML = '';

            allGames.forEach(g => {
                cont.innerHTML += `
                    <div class="game-card" onclick="openGame('${g.id}')">
                        <img src="${g.img}">
                        <div class="game-title">${g.name}</div>
                    </div>`;
                
                // Populate Admin Selects
                const opt = `<option value="${g.id}">${g.name}</option>`;
                admG.innerHTML += opt; admP.innerHTML += opt;
            });
            if(isAdmin) admLoadGame();
        }

        function openGame(gid) {
            const g = allGames.find(x => x.id === gid);
            document.getElementById('game-title').innerText = g.name;
            document.getElementById('screen-home').style.display = 'none';
            document.getElementById('screen-products').style.display = 'block';
            
            const cont = document.getElementById('products-container');
            cont.innerHTML = '';
            
            allProducts.filter(p => p.game_id === gid).forEach(p => {
                const isBought = purchasedItems.includes(p.id);
                const btnHtml = isBought 
                    ? `<button class="btn btn-get" onclick="openGetModal(${p.id})">–ü–û–õ–£–ß–ò–¢–¨</button>`
                    : `<button class="btn btn-buy" onclick="buyItem(${p.id}, ${p.price_c})">–ö—É–ø–∏—Ç—å</button>`;
                
                const offerHtml = p.is_offer ? `<div class="offer-badge">SALE</div>` : '';
                
                cont.innerHTML += `
                    <div class="item-card ${p.is_offer ? 'offer':''}">
                        ${offerHtml}
                        <img src="${p.img}" class="item-img" onerror="this.src='https://placehold.co/100'">
                        <div style="font-weight:bold; font-size:13px;">${p.name}</div>
                        <div style="font-size:11px; color:#aaa; margin-bottom:5px;">${p.price_c} üíé / ${p.price_r} ‚ÇΩ</div>
                        ${p.is_offer ? '<div style="font-size:10px; color:var(--red); font-weight:bold;">‚è≥ 59:00</div>' : ''}
                        ${btnHtml}
                    </div>`;
            });
        }

        function goHome() {
            document.getElementById('screen-products').style.display = 'none';
            document.getElementById('screen-home').style.display = 'block';
        }

        // --- PURCHASE FLOW ---
        async function buyItem(pid, price) {
            tg.showConfirm(`–°–ø–∏—Å–∞—Ç—å ${price} –º–æ–Ω–µ—Ç?`, async (ok) => {
                if(ok) {
                    const res = await api('/api/buy', 'POST', {user_id: USER_ID, price});
                    if(res && res.status === 'ok') {
                        document.getElementById('bal-c').innerText = res.new_balance;
                        purchasedItems.push(pid);
                        // Re-render to show "GET" button
                        const gTitle = document.getElementById('game-title').innerText;
                        const g = allGames.find(x => x.name === gTitle);
                        if(g) openGame(g.id);
                    } else {
                        tg.showAlert(res ? res.message : "Error");
                    }
                }
            });
        }

        function openGetModal(pid) {
            document.getElementById('modal-email').style.display = 'flex';
        }

        async function submitEmail() {
            const val = document.getElementById('email-in').value;
            if(!val) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");
            
            // Send data as chat message
            await api('/api/chat/send', 'POST', {user_id: USER_ID, sender: 'user', text: `[–ó–ê–ö–ê–ó] –î–∞–Ω–Ω—ã–µ: ${val}`});
            
            document.getElementById('modal-email').style.display = 'none';
            tg.showAlert("–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã! –ñ–¥–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.");
            
            // FAKE DELAY & NOTIFICATION
            setTimeout(() => {
                document.getElementById('notif-toast').classList.add('show');
                tg.HapticFeedback.notificationOccurred('success');
                setTimeout(() => document.getElementById('notif-toast').classList.remove('show'), 5000);
            }, 3000);
        }

        // --- CHAT SYSTEM ---
        function openChat(targetUid) {
            currentChatUserId = targetUid || USER_ID;
            document.getElementById('modal-chat').style.display = 'flex';
            loadChat();
            if(!chatInterval) chatInterval = setInterval(loadChat, 2000);
        }
        
        function closeModal(id) { 
            document.getElementById(id).style.display = 'none';
            if(id === 'modal-chat' && chatInterval) { clearInterval(chatInterval); chatInterval=null; }
        }

        async function loadChat() {
            const msgs = await api(`/api/chat?user_id=${currentChatUserId}`);
            const box = document.getElementById('chat-messages');
            box.innerHTML = '';
            if(msgs) msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = `msg ${m.sender}`;
                div.innerText = m.message;
                box.appendChild(div);
            });
        }

        async function sendMsg() {
            const inp = document.getElementById('chat-in');
            const txt = inp.value.trim();
            if(!txt) return;
            
            // –ï—Å–ª–∏ —è –∞–¥–º–∏–Ω –∏ –ø–∏—à—É –¥—Ä—É–≥–æ–º—É, —Ç–æ sender='support', –∏–Ω–∞—á–µ 'user'
            const sender = (isAdmin && currentChatUserId !== USER_ID) ? 'support' : 'user';
            
            await api('/api/chat/send', 'POST', {user_id: currentChatUserId, sender, text: txt});
            inp.value = '';
            loadChat();
        }

        // --- ADMIN PANEL ---
        function openAdmin() { 
            document.getElementById('modal-admin').style.display = 'flex'; 
            switchTab('adm-products'); // Default tab
        }

        function switchTab(id) {
            ['adm-products','adm-games','adm-crm'].forEach(t => document.getElementById(t).style.display='none');
            document.getElementById(id).style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if(id === 'adm-crm') loadCrm();
        }

        // Admin: Add Product
        async function admAddProduct() {
            const body = {
                gameId: document.getElementById('adm-p-game').value,
                name: document.getElementById('adm-p-name').value,
                priceC: document.getElementById('adm-p-pricec').value,
                priceR: document.getElementById('adm-p-pricer').value,
                img: document.getElementById('adm-p-img').value,
                isOffer: document.getElementById('adm-p-offer').checked
            };
            const res = await api('/api/admin/add_product', 'POST', body);
            if(res) { tg.showAlert("–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω!"); init(); } // reload content
        }

        // Admin: Edit Game
        function admLoadGame() {
            const gid = document.getElementById('adm-g-select').value;
            const g = allGames.find(x => x.id === gid);
            document.getElementById('adm-g-name').value = g.name;
            document.getElementById('adm-g-img').value = g.img;
        }

        async function admUpdateGame() {
            const body = {
                id: document.getElementById('adm-g-select').value,
                name: document.getElementById('adm-g-name').value,
                img: document.getElementById('adm-g-img').value
            };
            const res = await api('/api/admin/update_game', 'POST', body);
            if(res) { tg.showAlert("–û–±–ª–æ–∂–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!"); init(); }
        }

        // Admin: CRM
        async function loadCrm() {
            const users = await api('/api/admin/users');
            const cont = document.getElementById('crm-list');
            cont.innerHTML = '';
            if(users) users.forEach(u => {
                cont.innerHTML += `
                    <div class="user-row">
                        <div>
                            <div style="font-weight:bold;">${u.username}</div>
                            <div style="font-size:11px; color:#aaa;">ID: ${u.user_id} | üí∞ ${u.balance_coins}</div>
                        </div>
                        <button onclick="adminStartChat(${u.user_id})" style="background:#444; border:none; color:white; padding:5px 10px; border-radius:5px;">–ß–∞—Ç</button>
                    </div>`;
            });
        }

        function adminStartChat(uid) {
            closeModal('modal-admin');
            openChat(uid);
        }

        init();
    </script>
</body>
</html>
